import streamlit as st
import yfinance as yf
import pandas as pd
import ta

# è¨­å®šç¶²é æ¨™é¡Œ
st.set_page_config(page_title="é«˜å‹ç‡ AI äº¤æ˜“è¨Šè™Ÿå„€è¡¨æ¿", layout="wide")
st.title("ğŸ“ˆ è‚¡ç¥¨æ“ç›¤æ‰‹ï¼šæ—¥K + 5åˆ†K æœ€å¤§æ•ˆç›Šç­–ç•¥åˆ†æ")

# å´é‚Šæ¬„ï¼šè¼¸å…¥è‚¡ç¥¨ä»£ç¢¼
sidebar_ticker = st.sidebar.text_input("è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ (å¦‚ 2330.TW)", value="2330.TW")
st.sidebar.markdown("### ç­–ç•¥é‚è¼¯ï¼š\n1. **æ—¥K MACD** ç¢ºèªå¤šé ­è¶¨å‹¢\n2. **5åˆ†K å¸ƒæ—é€šé“** æŠ“çªç ´\n3. **5åˆ†K RSI & æˆäº¤é‡** ç¢ºèªå‹•èƒ½\n4. **SAR** ç§»å‹•åœåˆ©")

def get_data(ticker, period, interval):
    try:
        df = yf.download(ticker, period=period, interval=interval)
        if df.empty:
            return None
        return df
    except Exception as e:
        return None

def calculate_indicators(df):
    # MACD
    macd = ta.trend.MACD(close=df['Close'])
    df['MACD'] = macd.macd()
    df['MACD_Signal'] = macd.macd_signal()
    df['MACD_Hist'] = macd.macd_diff()
    
    # RSI
    df['RSI'] = ta.momentum.RSIIndicator(close=df['Close'], window=14).rsi()
    
    # Bollinger Bands
    indicator_bb = ta.volatility.BollingerBands(close=df['Close'], window=20, window_dev=2)
    df['BB_High'] = indicator_bb.bollinger_hband()
    df['BB_Low'] = indicator_bb.bollinger_lband()
    df['BB_Width'] = df['BB_High'] - df['BB_Low']
    
    # SAR
    df['SAR'] = ta.trend.PSARIndicator(df['High'], df['Low'], df['Close'], step=0.02, max_step=0.2).psar()
    
    # Volume MA
    df['Vol_MA5'] = df['Volume'].rolling(window=5).mean()
    
    return df

# ä¸»ç¨‹å¼é‚è¼¯
if sidebar_ticker:
    # 1. å–å¾—æ—¥ç·šè³‡æ–™ (åˆ¤æ–·å¤§è¶¨å‹¢)
    day_df = get_data(sidebar_ticker, "1y", "1d")
    
    # 2. å–å¾— 5åˆ†K è³‡æ–™ (åˆ¤æ–·é€²å‡ºå ´)
    five_min_df = get_data(sidebar_ticker, "5d", "5m")

    if day_df is not None and five_min_df is not None:
        # è¨ˆç®—æŒ‡æ¨™
        day_df = calculate_indicators(day_df)
        five_min_df = calculate_indicators(five_min_df)
        
        # å–å¾—æœ€æ–°ä¸€ç­†è³‡æ–™
        last_day = day_df.iloc[-1]
        last_5m = five_min_df.iloc[-1]
        prev_5m = five_min_df.iloc[-2] # å‰ä¸€æ ¹ 5åˆ†K ç”¨ä¾†ç¢ºèªçªç ´

        # --- ç­–ç•¥åˆ¤å®šæ ¸å¿ƒ ---
        
        # æ¢ä»¶ 1: æ—¥ K è¶¨å‹¢ (MACD æŸ±ç‹€é«” > 0 æˆ– DIF > 0)
        day_trend_bullish = last_day['MACD_Hist'] > 0 or last_day['MACD'] > 0
        
        # æ¢ä»¶ 2: 5åˆ†K å¸ƒæ—å¸¶çªç ´ (æ”¶ç›¤åƒ¹ > ä¸Šè»Œ)
        bb_breakout = last_5m['Close'] > last_5m['BB_High']
        
        # æ¢ä»¶ 3: 5åˆ†K çˆ†é‡ (æˆäº¤é‡ > 5å‡é‡)
        volume_spike = last_5m['Volume'] > last_5m['Vol_MA5']
        
        # æ¢ä»¶ 4: 5åˆ†K RSI å‹•èƒ½ (RSI > 50)
        rsi_bullish = last_5m['RSI'] > 50
        
        # æ¢ä»¶ 5: 5åˆ†K SAR ç¿»å¤š (åƒ¹æ ¼ > SAR)
        sar_bullish = last_5m['Close'] > last_5m['SAR']

        # --- é¡¯ç¤ºå„€è¡¨æ¿ ---
        col1, col2, col3 = st.columns(3)
        
        with col1:
            st.subheader("1. æ—¥ç·šæˆ°ç•¥ (å¤§è¶¨å‹¢)")
            if day_trend_bullish:
                st.success(f"å¤šé ­å¸‚å ´ (MACDæŸ±ç‹€: {last_day['MACD_Hist']:.2f})")
            else:
                st.error(f"ç©ºé ­/ç›¤æ•´ (MACDæŸ±ç‹€: {last_day['MACD_Hist']:.2f})")
                st.warning("âš ï¸ æ—¥ç·šåç©ºï¼Œå»ºè­°è§€æœ›ï¼Œå‹¿åšå¤šç•¶æ²–")

        with col2:
            st.subheader("2. 5åˆ†K æˆ°è¡“ (é€²å ´è¨Šè™Ÿ)")
            st.metric("ç›®å‰åƒ¹æ ¼", f"{last_5m['Close']:.2f}")
            
            # è¨Šè™Ÿæª¢æ ¸è¡¨
            checks = {
                "å¸ƒæ—çªç ´": bb_breakout,
                "æˆäº¤é‡æ”¾å¤§": volume_spike,
                "RSI > 50": rsi_bullish,
                "ç«™ä¸Š SAR": sar_bullish
            }
            
            for name, result in checks.items():
                icon = "âœ…" if result else "âŒ"
                st.write(f"{icon} {name}")

        with col3:
            st.subheader("3. AI ç¸½çµå»ºè­°")
            if day_trend_bullish and all(checks.values()):
                st.balloons()
                st.markdown("### ğŸš€ å¼·åŠ›è²·é€²è¨Šè™Ÿï¼")
                st.write(f"åœæä½ (SAR): **{last_5m['SAR']:.2f}**")
                st.info("ç­–ç•¥ï¼šé€²å ´å¾Œæ²¿è‘— SAR ç§»å‹•åœåˆ©ï¼Œè·Œç ´å³å‡ºå ´ã€‚")
            elif day_trend_bullish and sar_bullish and rsi_bullish:
                st.markdown("### ğŸ‘€ è§€å¯Ÿä¸­ (ç­‰å¾…å¸¶é‡çªç ´)")
            else:
                st.markdown("### ğŸ›‘ ç©ºæ‰‹è§€æœ›")

        # ç¹ªåœ–å€ (5åˆ†K)
        st.subheader("5åˆ†é˜ K ç·šåœ–èˆ‡å¸ƒæ—é€šé“")
        st.line_chart(five_min_df[['Close', 'BB_High', 'BB_Low', 'SAR']].tail(100))

    else:
        st.error("ç„¡æ³•å–å¾—è³‡æ–™ï¼Œè«‹æª¢æŸ¥è‚¡ç¥¨ä»£ç¢¼æˆ–æ˜¯ç›®å‰éäº¤æ˜“æ™‚é–“ã€‚")
